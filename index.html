<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a","950":"#172554"}
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "react-dom/server": "https://esm.sh/react-dom@18.2.0/server.browser",
          "qrcode.react": "https://esm.sh/qrcode.react@3.1.0",
          "exceljs": "https://esm.sh/exceljs@4.4.0",
          "file-saver": "https://esm.sh/file-saver@2.0.5"
        }
      }
    </script>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, createContext, useContext, useCallback, useMemo, useRef, Fragment } from 'react';
      import ReactDOM from 'react-dom/client';
      import { renderToStaticMarkup } from 'react-dom/server';
      import { QRCodeSVG } from 'qrcode.react';
      import ExcelJS from 'exceljs';
      import saveAs from 'file-saver';

      // --- From constants.ts ---
      const SUPERVISOR_QR_ID = "SUP_ADMIN_999";
      const SUPERVISOR_NAME = "Supervisor";
      const SUPERVISOR_PASSWORD = "BHP_Supervisor_2025";
      const OPERATOR_PASSWORD = "MOLEX_OPR_PASS";
      const LOGOUT_QR_ID = "OPERATOR_LOGOUT";

      const TEAM_QR = {
        "MOLEX_OPR_1": "Nagendra",
        "MOLEX_OPR_2": "Deve",
        "MOLEX_OPR_3": "Prakash",
        "MOLEX_OPR_4": "Anil",
        "MOLEX_OPR_5": "Rakshita",
        "MOLEX_OPR_6": "Asalam",
        "MOLEX_OPR_7": "Shivraj",
        "MOLEX_OPR_8": "Anil.V",
        "MOLEX_OPR_9": "Abhinandan",
        "MOLEX_OPR_10": "Narayan",
      };

      const LOW_STOCK_THRESHOLD = 5;

      const INITIAL_PARTS = [
        { id: "PN-1001", name: "3mm Red LED", location: "A1-01", quantity: 50 },
        { id: "PN-1002", name: "5mm Green LED", location: "A1-02", quantity: 45 },
        { id: "PN-2001", name: "220 Ohm Resistor", location: "B2-05", quantity: 150 },
        { id: "PN-2002", name: "10k Ohm Resistor", location: "B2-06", quantity: 120 },
        { id: "PN-3001", name: "Atmega328P Microcontroller", location: "C3-10", quantity: 20 },
        { id: "PN-3002", name: "ESP32 Development Board", location: "C3-11", quantity: 15 },
        { id: "PN-4001", name: "SG90 Servo Motor", location: "D4-15", quantity: 8 },
        { id: "PN-4002", name: "28BYJ-48 Stepper Motor", location: "D4-16", quantity: 4 },
      ];

      // --- From components/icons/Icons.tsx ---
      const QrCodeIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 4.5A.75.75 0 0 1 4.5 3.75h4.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-.75.75h-4.5a.75.75 0 0 1-.75-.75v-4.5ZM3.75 14.25a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-.75.75h-4.5a.75.75 0 0 1-.75-.75v-4.5ZM13.5 4.5a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-.75.75h-4.5a.75.75 0 0 1-.75-.75v-4.5Z" />
          <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 15.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm-3-3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm-3 0h.008v.008h-.008v-.008Zm-3 0h.008v.008h-.008v-.008Z" />
        </svg>
      );
      const UserCircleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      const LogoutIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
      );
      const CheckCircleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      const ExclamationTriangleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      );
      const InformationCircleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      const DocumentTextIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      );
      const XCircleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      const PlusCircleIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      const ChartBarIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
      );
      const CogIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
      );
      const SearchIcon = ({ className = 'w-5 h-5' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
      );
      const DownloadIcon = ({ className = 'w-5 h-5' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
      );
      const RefreshIcon = ({ className = 'w-5 h-5' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120 12M20 20l-1.5-1.5A9 9 0 004 12" />
          </svg>
      );
      const MolexLogo = ({ className = 'w-48' }) => (
          <svg viewBox="0 0 200 50" className={className} xmlns="http://www.w3.org/2000/svg">
              <text 
                  fontFamily="'Arial Black', 'Gadget', sans-serif" 
                  fontSize="40" 
                  y="40" 
                  x="0" 
                  fill="#FFFFFF"
              >
                  M<tspan fill="#E2231A">O</tspan>LEX
              </text>
          </svg>
      );
      const FilterIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
          </svg>
      );
      const QrCodeIconSolid = QrCodeIcon; // Alias for supervisor dashboard icon


      // --- From hooks/useUsbScanner.ts ---
      const useUsbScanner = (onScan, enabled = true) => {
        const buffer = useRef([]);
        const timeoutId = useRef(null);
        const SCAN_TIMEOUT_MS = 100;

        useEffect(() => {
          if (!enabled) return;

          const handleKeyDown = (event) => {
            if (event.key.length > 1 && event.key !== 'Enter') return;
            if (timeoutId.current) clearTimeout(timeoutId.current);
            if (event.key === 'Enter') {
              if (buffer.current.length > 2) {
                onScan(buffer.current.join(''));
              }
              buffer.current = [];
              return;
            }
            buffer.current.push(event.key);
            timeoutId.current = setTimeout(() => {
              buffer.current = [];
            }, SCAN_TIMEOUT_MS);
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => {
            window.removeEventListener('keydown', handleKeyDown);
            if (timeoutId.current) clearTimeout(timeoutId.current);
          };
        }, [onScan, enabled]);
      };

      // --- From components/common/Modal.tsx ---
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;

        return (
          <div 
            className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300"
            onClick={onClose}
          >
            <div
              className="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg mx-4 border border-gray-700 transform transition-all duration-300 scale-95 opacity-0 animate-fade-in-scale"
              onClick={(e) => e.stopPropagation()}
              style={{ animation: 'fade-in-scale 0.3s forwards' }}
            >
              <div className="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 className="text-xl font-semibold text-white">{title}</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-white">
                  <XCircleIcon />
                </button>
              </div>
              <div>{children}</div>
            </div>
            <style>{`
              @keyframes fade-in-scale {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
              }
              .animate-fade-in-scale {
                animation: fade-in-scale 0.2s ease-out forwards;
              }
            `}</style>
          </div>
        );
      };
      
      // --- From components/common/StatCard.tsx ---
      const StatCard = ({ title, value, icon }) => (
          <div className="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center gap-6 border border-gray-700">
              <div className="text-primary-400">{icon}</div>
              <div>
                  <p className="text-sm text-gray-400 uppercase tracking-wider">{title}</p>
                  <p className="text-2xl font-bold text-white">{value}</p>
              </div>
          </div>
      );

      // --- From hooks/useInventory.tsx ---
      const InventoryContext = createContext(undefined);

      const InventoryProvider = ({ children }) => {
        const [parts, setParts] = useState([]);
        const [logs, setLogs] = useState([]);
        const [isLoading, setIsLoading] = useState(true);

        useEffect(() => {
          try {
            const storedParts = localStorage.getItem('inventory_parts');
            const storedLogs = localStorage.getItem('inventory_logs');
            if (storedParts) setParts(JSON.parse(storedParts));
            else setParts(INITIAL_PARTS);
            if (storedLogs) setLogs(JSON.parse(storedLogs));
          } catch (error) {
            console.error("Failed to load data from localStorage", error);
            setParts(INITIAL_PARTS);
          } finally {
            setIsLoading(false);
          }
        }, []);

        useEffect(() => {
          if(!isLoading) localStorage.setItem('inventory_parts', JSON.stringify(parts));
        }, [parts, isLoading]);
        
        useEffect(() => {
          if(!isLoading) localStorage.setItem('inventory_logs', JSON.stringify(logs));
        }, [logs, isLoading]);

        const addLog = useCallback((logEntry) => {
          setLogs(prevLogs => {
            const newLog = { ...logEntry, timestamp: new Date().toISOString() };
            return [newLog, ...prevLogs];
          });
        }, []);

        const takePart = (partId, operatorId) => {
          let success = false;
          let message = "Part not found.";
          let part = null;

          setParts(currentParts => {
            const partIndex = currentParts.findIndex(p => p.id.toUpperCase() === partId.toUpperCase());
            if (partIndex === -1) return currentParts;
            
            const updatedParts = [...currentParts];
            part = updatedParts[partIndex];

            if (part.quantity <= 0) {
              message = `${part.name} is out of stock!`;
              return currentParts;
            }

            part.quantity -= 1;
            
            addLog({
              operatorId,
              action: "Take (1-Scan)",
              partName: part.name,
              partId: part.id,
              quantityChange: -1,
              remaining: part.quantity,
            });
            
            success = true;
            message = `${part.name} stock reduced by 1. Remaining: ${part.quantity}`;
            if (part.quantity <= LOW_STOCK_THRESHOLD) {
                message += `\nLOW STOCK ALERT!`;
            }
            return updatedParts;
          });
          return { success, message, part };
        };

        const addPart = (newPartData) => {
          const partId = (newPartData.id || `PN-${Date.now()}`).toUpperCase();
          if (parts.some(p => p.id.toUpperCase() === partId)) {
              return { success: false, message: "Part ID already exists." };
          }
          const newPart = { ...newPartData, id: partId };
          setParts(prev => [...prev, newPart]);
          addLog({
              operatorId: "Supervisor",
              action: "Add Part",
              partName: newPart.name,
              partId: newPart.id,
              quantityChange: newPart.quantity,
              remaining: newPart.quantity,
          });
          return { success: true, message: `${newPart.name} added successfully.` };
        };
        
        const removePart = (partId) => {
            const partToRemove = parts.find(p => p.id === partId);
            if (!partToRemove) return { success: false, message: "Part not found." };
            
            setParts(prev => prev.filter(p => p.id !== partId));
            addLog({
                operatorId: "Supervisor",
                action: "Remove Part",
                partName: partToRemove.name,
                partId: partToRemove.id,
                quantityChange: 0,
                remaining: 0,
            });
            return { success: true, message: `${partToRemove.name} removed.` };
        };

        const restockPart = (partId, quantity) => {
            if (quantity <= 0) return { success: false, message: "Restock quantity must be positive." };
            const partIndex = parts.findIndex(p => p.id === partId);
            if (partIndex === -1) return { success: false, message: "Part not found." };

            const updatedParts = [...parts];
            const part = updatedParts[partIndex];
            part.quantity += quantity;
            setParts(updatedParts);
            addLog({
                operatorId: "Supervisor",
                action: "Restock",
                partName: part.name,
                partId: part.id,
                quantityChange: quantity,
                remaining: part.quantity,
            });
            return { success: true, message: `${part.name} restocked by ${quantity}.` };
        };
        
        const searchParts = (query) => {
            if (!query) return parts;
            const upperQuery = query.toUpperCase();
            return parts.filter(p => p.id.toUpperCase().includes(upperQuery) || p.name.toUpperCase().includes(upperQuery));
        };

        const getLowStockParts = () => {
          return parts.filter(p => p.quantity <= LOW_STOCK_THRESHOLD);
        };
        
        const exportLogsToExcel = async () => {
          const workbook = new ExcelJS.Workbook();
          const worksheet = workbook.addWorksheet('Activity Logs');

          worksheet.columns = [
              { header: 'Timestamp', key: 'timestamp', width: 25 },
              { header: 'Operator', key: 'operatorId', width: 20 },
              { header: 'Action', key: 'action', width: 20 },
              { header: 'Part Name', key: 'partName', width: 30 },
              { header: 'Part ID', key: 'partId', width: 20 },
              { header: 'Qty Change', key: 'quantityChange', width: 15 },
              { header: 'Remaining', key: 'remaining', width: 15 },
          ];

          worksheet.getRow(1).eachCell(cell => {
              cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' }};
              cell.alignment = { vertical: 'middle', horizontal: 'center' };
          });

          logs.forEach(log => {
              worksheet.addRow({ ...log, timestamp: new Date(log.timestamp).toLocaleString() });
          });

          const buffer = await workbook.xlsx.writeBuffer();
          const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          saveAs(blob, `inventory_logs_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        const resetAllStock = (quantity) => {
          setParts(prevParts => prevParts.map(p => ({ ...p, quantity })));
          addLog({
            operatorId: "Supervisor",
            action: "Reset All Stock",
            partName: "ALL",
            partId: "ALL",
            quantityChange: quantity,
            remaining: quantity
          });
        };

        const value = { parts, logs, isLoading, takePart, addPart, removePart, restockPart, searchParts, getLowStockParts, exportLogsToExcel, resetAllStock };
        return <InventoryContext.Provider value={value}>{children}</InventoryContext.Provider>;
      };

      const useInventory = () => {
        const context = useContext(InventoryContext);
        if (context === undefined) throw new Error('useInventory must be used within an InventoryProvider');
        return context;
      };


      // --- From components/QrCodeManagement.tsx ---
      const QrCodeManagement = ({ parts, users }) => {
          const [isLoading, setIsLoading] = useState(false);

          const convertSvgToPngBase64 = (svgString, size) => {
              return new Promise((resolve, reject) => {
                  const img = new Image();
                  const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                  const url = URL.createObjectURL(svgBlob);

                  img.onload = () => {
                      const canvas = document.createElement('canvas');
                      canvas.width = size;
                      canvas.height = size;
                      const ctx = canvas.getContext('2d');
                      if (!ctx) {
                          URL.revokeObjectURL(url);
                          return reject(new Error('Could not get canvas context'));
                      }
                      ctx.drawImage(img, 0, 0, size, size);
                      const pngDataUrl = canvas.toDataURL('image/png');
                      URL.revokeObjectURL(url);
                      resolve(pngDataUrl);
                  };
                  img.onerror = (err) => {
                      URL.revokeObjectURL(url);
                      reject(err);
                  };
                  img.src = url;
              });
          };

          const handleExport = async () => {
              setIsLoading(true);
              try {
                  const workbook = new ExcelJS.Workbook();
                  workbook.creator = 'Inventory Management System';
                  
                  const qrSize = 60;

                  const usersSheet = workbook.addWorksheet('Users & System');
                  usersSheet.columns = [
                      { header: 'Name', key: 'name', width: 30 },
                      { header: 'ID', key: 'id', width: 30 },
                      { header: 'QR Code', key: 'qr', width: qrSize / 6 },
                  ];
                  usersSheet.getRow(1).font = { bold: true };
                  
                  for (const [index, user] of users.entries()) {
                      usersSheet.addRow({ name: user.name, id: user.id });
                      usersSheet.getRow(index + 2).height = qrSize * 0.75;
                      
                      const svgString = renderToStaticMarkup(<QRCodeSVG value={user.id} size={128} level="L" />);
                      const pngDataUrl = await convertSvgToPngBase64(svgString, 128);
                      
                      const imageId = workbook.addImage({
                          base64: pngDataUrl.substring(pngDataUrl.indexOf(',') + 1),
                          extension: 'png',
                      });
                      usersSheet.addImage(imageId, {
                          tl: { col: 2.1, row: index + 1.05 },
                          ext: { width: qrSize, height: qrSize },
                      });
                  }

                  const partsSheet = workbook.addWorksheet('Inventory Parts');
                  partsSheet.columns = [
                      { header: 'Part Name', key: 'name', width: 40 },
                      { header: 'Part ID', key: 'id', width: 30 },
                      { header: 'QR Code', key: 'qr', width: qrSize / 6 },
                  ];
                  partsSheet.getRow(1).font = { bold: true };

                  for (const [index, part] of parts.entries()) {
                      partsSheet.addRow({ name: part.name, id: part.id });
                      partsSheet.getRow(index + 2).height = qrSize * 0.75;

                      const svgString = renderToStaticMarkup(<QRCodeSVG value={part.id} size={128} level="L" />);
                      const pngDataUrl = await convertSvgToPngBase64(svgString, 128);
                      
                      const imageId = workbook.addImage({
                          base64: pngDataUrl.substring(pngDataUrl.indexOf(',') + 1),
                          extension: 'png',
                      });
                      partsSheet.addImage(imageId, {
                          tl: { col: 2.1, row: index + 1.05 },
                          ext: { width: qrSize, height: qrSize },
                      });
                  }

                  const buffer = await workbook.xlsx.writeBuffer();
                  saveAs(new Blob([buffer]), `inventory_qrcodes_${new Date().toISOString().split('T')[0]}.xlsx`);

              } catch (error) {
                  console.error("Failed to generate Excel file", error);
                  alert("An error occurred while generating the Excel file.");
              } finally {
                  setIsLoading(false);
              }
          };

          return (
              <div className="text-white">
                  <div className="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6 flex justify-between items-center">
                      <div>
                          <h2 className="text-2xl font-bold">QR Code Management</h2>
                          <p className="text-gray-400 mt-2">
                              View QR codes directly or download an Excel file with embedded QR images for printing.
                          </p>
                      </div>
                      <button
                          onClick={handleExport}
                          disabled={isLoading}
                          className="flex items-center gap-2 bg-primary-600 hover:bg-primary-500 text-white font-bold py-3 px-6 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"
                      >
                          <DownloadIcon />
                          {isLoading ? 'Generating...' : 'Download QR Codes (Excel)'}
                      </button>
                  </div>
                  <div className="space-y-8">
                      <div>
                          <h3 className="text-xl font-semibold mb-4 text-white">Users & System QR Codes</h3>
                          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                              {users.map(user => (
                                  <div key={user.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700 text-center">
                                      <div className="bg-white p-2 rounded-md inline-block">
                                          <QRCodeSVG value={user.id} size={128} />
                                      </div>
                                      <p className="mt-2 font-semibold text-white">{user.name}</p>
                                      <p className="font-mono text-xs text-gray-400">{user.id}</p>
                                  </div>
                              ))}
                          </div>
                      </div>
                       <div>
                          <h3 className="text-xl font-semibold mb-4 text-white">Inventory Part QR Codes</h3>
                           <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                              {parts.map(part => (
                                  <div key={part.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700 text-center">
                                      <div className="bg-white p-2 rounded-md inline-block">
                                          <QRCodeSVG value={part.id} size={128} />
                                      </div>
                                      <p className="mt-2 font-semibold text-white truncate" title={part.name}>{part.name}</p>
                                      <p className="font-mono text-xs text-gray-400">{part.id}</p>
                                  </div>
                              ))}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      // --- From components/LoginPromptScreen.tsx ---
      const LoginPromptScreen = ({ error }) => {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-900 text-center">
              <div className="flex justify-center mb-6">
                  <MolexLogo />
              </div>
              <h1 className="text-4xl sm:text-5xl font-bold text-primary-400 mb-4">Inventory Manager</h1>
              
              <div className="mt-8 flex flex-col items-center">
                  <QrCodeIcon className="w-24 h-24 text-gray-500 animate-pulse" />
                  <p className="text-2xl text-gray-300 mt-6">Scan your ID card to begin.</p>
              </div>

              {error && (
                  <div className="mt-8 bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-lg flex items-center gap-3">
                      <ExclamationTriangleIcon className="w-6 h-6"/>
                      <span>{error}</span>
                  </div>
              )}
          </div>
        );
      };

      // --- From components/OperatorView.tsx ---
      const OperatorView = ({ currentUser, onLogout, onSwitchToSupervisor }) => {
        const { takePart, logs } = useInventory();
        const [lastMessage, setLastMessage] = useState({ text: 'Welcome! Scan a part to begin.', type: 'info' });
        const [recentLogs, setRecentLogs] = useState([]);

        const handleScan = (scannedCode) => {
          if (scannedCode === LOGOUT_QR_ID) {
            onLogout();
            return;
          }
          if (scannedCode === SUPERVISOR_QR_ID) {
            onSwitchToSupervisor();
            return;
          }
          const { success, message } = takePart(scannedCode, currentUser.name);
          setLastMessage({ text: message, type: success ? 'success' : 'error' });
        };

        useUsbScanner(handleScan, true);

        useEffect(() => {
          const operatorLogs = logs.filter(log => log.operatorId === currentUser.name).slice(0, 5);
          setRecentLogs(operatorLogs);
        }, [logs, currentUser.name]);
        
        const getIconForMessageType = (type) => {
          switch(type) {
            case 'success': return <CheckCircleIcon className="w-8 h-8 text-green-400" />;
            case 'error': return <ExclamationTriangleIcon className="w-8 h-8 text-red-400" />;
            case 'info': return <InformationCircleIcon className="w-8 h-8 text-blue-400" />;
          }
        };

        return (
          <div className="min-h-screen flex flex-col bg-gray-800">
              <header className="bg-gray-900 shadow-md p-4 flex justify-between items-center border-b border-gray-700">
                  <div className="flex items-center gap-4">
                      <MolexLogo className="w-24"/>
                      <div className="text-xl font-bold text-primary-400 hidden sm:block">
                          Operator: <span className="text-white">{currentUser.name}</span>
                      </div>
                  </div>
                  <div className="flex items-center gap-2">
                      <div className="text-lg font-bold text-white sm:hidden">
                          {currentUser.name}
                      </div>
                      <button
                          onClick={onLogout}
                          className="flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                      >
                          <LogoutIcon />
                          <span className="hidden sm:inline">Logout</span>
                      </button>
                  </div>
              </header>
              <main className="flex-grow flex flex-col items-center justify-center p-4 sm:p-8">
                  <div className="w-full max-w-4xl text-center">
                      <div className="mb-8">
                          <h2 className="text-3xl font-bold text-gray-300">Ready to Scan</h2>
                          <p className="text-gray-400">Scan a part's QR code to deduct one item from stock.</p>
                      </div>
                       <div className="w-full max-w-lg mx-auto">
                           <div className={`p-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-4 text-lg ${
                            lastMessage?.type === 'success' ? 'bg-green-900/50 text-green-300' : 
                            lastMessage?.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-blue-900/50 text-blue-300'
                          }`}>
                            {lastMessage && getIconForMessageType(lastMessage.type)}
                            <div className="whitespace-pre-wrap font-semibold">{lastMessage?.text}</div>
                          </div>
                       </div>
                  </div>
              </main>
              <footer className="bg-gray-900 p-4 border-t border-gray-700">
                  <div className="max-w-4xl mx-auto">
                      <h3 className="text-lg font-semibold mb-2 flex items-center gap-2 text-gray-300"><DocumentTextIcon/> Your Recent Activity</h3>
                      <div className="space-y-2 text-sm">
                          {recentLogs.length > 0 ? recentLogs.map((log, index) => (
                              <div key={index} className="flex justify-between items-center p-2 bg-gray-800 rounded-md">
                                  <div className="flex items-center gap-3">
                                      <span className="font-mono text-primary-400">{new Date(log.timestamp).toLocaleTimeString()}</span>
                                      <span className="text-white">{log.partName} ({log.partId})</span>
                                  </div>
                                  <div className="text-right">
                                      <span className="font-semibold text-gray-300">{log.action}</span>
                                      <span className="ml-2 font-mono text-red-400">{log.quantityChange}</span>
                                      <span className="ml-2 text-gray-400">(Rem: {log.remaining})</span>
                                  </div>
                              </div>
                          )) : <p className="text-gray-500">Scan your first part to see activity here.</p>}
                      </div>
                  </div>
              </footer>
          </div>
        );
      };

      // --- From components/SupervisorDashboard.tsx ---
      const PartFormModal = ({ isOpen, onClose, onSave, partToEdit }) => {
          const [partId, setPartId] = useState('');
          const [name, setName] = useState('');
          const [location, setLocation] = useState('');
          const [quantity, setQuantity] = useState(0);

          useEffect(() => {
              if (partToEdit) {
                  setPartId(partToEdit.id);
                  setName(partToEdit.name);
                  setLocation(partToEdit.location);
                  setQuantity(partToEdit.quantity);
              } else {
                  setPartId('');
                  setName('');
                  setLocation('');
                  setQuantity(0);
              }
          }, [partToEdit, isOpen]);

          const handleSubmit = (e) => {
              e.preventDefault();
              onSave({ id: partId, name, location, quantity });
              onClose();
          };

          return (
              <Modal isOpen={isOpen} onClose={onClose} title={partToEdit ? 'Edit Part' : 'Add New Part'}>
                  <form onSubmit={handleSubmit} className="p-4 space-y-4">
                      <div>
                          <label className="block text-sm font-medium text-gray-300">Part ID</label>
                          <input
                              type="text"
                              value={partId}
                              onChange={(e) => setPartId(e.target.value.toUpperCase())}
                              className="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2 mt-1"
                              required
                              disabled={!!partToEdit}
                          />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-300">Part Name</label>
                          <input
                              type="text"
                              value={name}
                              onChange={(e) => setName(e.target.value)}
                              className="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2 mt-1"
                              required
                          />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-300">Location</label>
                          <input
                              type="text"
                              value={location}
                              onChange={(e) => setLocation(e.target.value)}
                              className="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2 mt-1"
                              required
                          />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-300">Quantity</label>
                          <input
                              type="number"
                              value={quantity}
                              onChange={(e) => setQuantity(parseInt(e.target.value, 10))}
                              className="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2 mt-1"
                              required
                              min="0"
                          />
                      </div>
                      <div className="flex justify-end gap-2 pt-4">
                          <button type="button" onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                          <button type="submit" className="bg-primary-600 hover:bg-primary-500 text-white font-bold py-2 px-4 rounded-lg">Save Part</button>
                      </div>
                  </form>
              </Modal>
          );
      };

      const SupervisorDashboard = ({ currentUser, onLogout }) => {
          const { parts, logs, getLowStockParts, addPart, removePart, restockPart, searchParts, exportLogsToExcel, resetAllStock } = useInventory();
          const [activeTab, setActiveTab] = useState('dashboard');
          const [searchTerm, setSearchTerm] = useState('');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [qrCodeValue, setQrCodeValue] = useState(null);

          const [operatorFilter, setOperatorFilter] = useState('all');
          const [dateFilter, setDateFilter] = useState('all');

          const filteredParts = useMemo(() => searchParts(searchTerm), [searchTerm, parts, searchParts]);
          const lowStockParts = useMemo(() => getLowStockParts(), [getLowStockParts, parts]);

          const teamActivity = useMemo(() => {
              const activity = {};
              logs.forEach(log => {
                  if (log.operatorId !== 'Supervisor') {
                      activity[log.operatorId] = (activity[log.operatorId] || 0) + 1;
                  }
              });
              return Object.entries(activity).sort(([, a], [, b]) => b - a);
          }, [logs]);
          
          const filteredLogs = useMemo(() => {
              return logs.filter(log => {
                  const operatorMatch = operatorFilter === 'all' || log.operatorId === operatorFilter;
                  if (!operatorMatch) return false;
                  if (dateFilter === 'all') return true;
                  const logDate = new Date(log.timestamp);
                  const today = new Date();
                  today.setHours(0, 0, 0, 0);
                  if (dateFilter === 'today') return logDate >= today;
                  if (dateFilter === '7days') {
                      const sevenDaysAgo = new Date();
                      sevenDaysAgo.setDate(today.getDate() - 7);
                      sevenDaysAgo.setHours(0, 0, 0, 0);
                      return logDate >= sevenDaysAgo;
                  }
                  return true;
              });
          }, [logs, operatorFilter, dateFilter]);

          const topStockedItems = useMemo(() => [...parts].sort((a, b) => b.quantity - a.quantity).slice(0, 5), [parts]);
          const maxStock = Math.max(...topStockedItems.map(p => p.quantity), 1);

          const handleAddPart = (partData) => addPart(partData);

          const handleRestock = (partId) => {
              const quantityStr = prompt("Enter quantity to add:");
              if (quantityStr) {
                  const quantity = parseInt(quantityStr, 10);
                  if (!isNaN(quantity) && quantity > 0) restockPart(partId, quantity);
                  else alert("Invalid quantity.");
              }
          };
          
          const handleResetAllStock = () => {
              const quantityStr = prompt("Enter new quantity for ALL parts:");
              if (quantityStr) {
                  const quantity = parseInt(quantityStr, 10);
                  if (!isNaN(quantity) && quantity >= 0) {
                      if(window.confirm(`Are you sure you want to set ALL parts to a quantity of ${quantity}?`)) {
                          resetAllStock(quantity);
                      }
                  } else alert("Invalid quantity.");
              }
          };
          
          const TABS = {
              dashboard: { label: 'Dashboard', icon: <ChartBarIcon /> },
              'current-stock': { label: 'Current Stock', icon: <DocumentTextIcon /> },
              'activity-log': { label: 'Activity Log', icon: <CogIcon /> },
              qrcodes: { label: 'QR Codes', icon: <QrCodeIconSolid /> },
          };

          const renderContent = () => {
              switch (activeTab) {
                  case 'dashboard':
                       return (
                          <div className="space-y-8">
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                  <StatCard title="Total Unique Parts" value={parts.length} icon={<DocumentTextIcon className="w-8 h-8"/>} />
                                  <StatCard title="Total Stock Items" value={parts.reduce((sum, p) => sum + p.quantity, 0)} icon={<ChartBarIcon className="w-8 h-8"/>}/>
                                  <StatCard title="Low Stock Items" value={lowStockParts.length} icon={<ExclamationTriangleIcon className="w-8 h-8"/>}/>
                              </div>
                               <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                  <div>
                                      <h3 className="text-xl font-semibold mb-4 text-white">Top 5 Stocked Items</h3>
                                      <div className="bg-gray-800 rounded-lg p-6 space-y-4 border border-gray-700">
                                      {topStockedItems.length > 0 ? topStockedItems.map(item => (
                                          <div key={item.id} className="flex items-center gap-4 group">
                                              <div className="w-1/3 truncate text-sm text-gray-300" title={item.name}>{item.name}</div>
                                              <div className="w-2/3 bg-gray-700 rounded-full h-6">
                                                  <div 
                                                      className="bg-primary-600 h-6 rounded-full flex items-center justify-end px-2 text-white text-xs font-bold transition-all duration-500"
                                                      style={{ width: `${(item.quantity / maxStock) * 100}%` }}
                                                  >
                                                      {item.quantity}
                                                  </div>
                                              </div>
                                          </div>
                                      )) : <p className="text-gray-400">No inventory data to display.</p>}
                                      </div>
                                  </div>
                                  <div>
                                      <h3 className="text-xl font-semibold mb-4 text-white">Team Activity</h3>
                                      <div className="bg-gray-800 rounded-lg p-4 max-h-80 overflow-y-auto border border-gray-700">
                                      {teamActivity.length > 0 ? (
                                              <ul className="space-y-2">
                                                  {teamActivity.map(([name, count]) => (
                                                      <li key={name} className="flex justify-between items-center text-sm p-3 bg-gray-700/50 rounded">
                                                          <div className="flex items-center gap-2">
                                                              <UserCircleIcon className="w-5 h-5 text-gray-400" />
                                                              <span className="font-medium text-white">{name}</span>
                                                          </div>
                                                          <span className="font-bold text-primary-400">{count} actions</span>
                                                      </li>
                                                  ))}
                                              </ul>
                                      ) : <p className="text-gray-400">No operator activity recorded yet.</p>}
                                      </div>
                                  </div>
                              </div>
                          </div>
                      );
                  case 'current-stock':
                       return (
                          <div>
                              <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                 <div className="relative w-full sm:w-auto">
                                      <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>
                                      <input
                                          type="text"
                                          placeholder="Search by ID or Name..."
                                          value={searchTerm}
                                          onChange={(e) => setSearchTerm(e.target.value)}
                                          className="bg-gray-700 border border-gray-600 text-white rounded-lg p-2 pl-10 w-full sm:w-64"
                                      />
                                 </div>
                                 <div className="flex gap-2">
                                      <button onClick={handleResetAllStock} className="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">
                                          <RefreshIcon /> Reset All
                                      </button>
                                      <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 bg-primary-600 hover:bg-primary-500 text-white font-bold py-2 px-4 rounded-lg">
                                          <PlusCircleIcon /> Add Part
                                      </button>
                                 </div>
                              </div>
                              <div className="overflow-x-auto bg-gray-800 rounded-lg">
                                  <table className="min-w-full divide-y divide-gray-700">
                                      <thead className="bg-gray-700/50">
                                          <tr>
                                              {['Part ID', 'Name', 'Location', 'Quantity', 'Actions'].map(h => (
                                                  <th key={h} className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">{h}</th>
                                              ))}
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-700">
                                          {filteredParts.map(part => (
                                              <tr key={part.id} className="hover:bg-gray-700/50">
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{part.id}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{part.name}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{part.location}</td>
                                                  <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold ${lowStockParts.some(p => p.id === part.id) ? 'text-red-400' : 'text-white'}`}>{part.quantity}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                      <button onClick={() => setQrCodeValue(part.id)} className="text-blue-400 hover:text-blue-300"><QrCodeIconSolid/></button>
                                                      <button onClick={() => handleRestock(part.id)} className="text-green-400 hover:text-green-300"><PlusCircleIcon/></button>
                                                      <button onClick={() => removePart(part.id)} className="text-red-400 hover:text-red-300"><XCircleIcon/></button>
                                                  </td>
                                              </tr>
                                          ))}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      );
                  case 'activity-log':
                      const operatorNames = [SUPERVISOR_NAME, ...Object.values(TEAM_QR)];
                      return (
                          <div>
                              <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                                 <div className="flex items-center gap-4">
                                      <h3 className="text-lg font-semibold text-white flex items-center gap-2"><FilterIcon /> Filters</h3>
                                      <select value={operatorFilter} onChange={e => setOperatorFilter(e.target.value)} className="bg-gray-700 border border-gray-600 text-white rounded-lg p-2">
                                          <option value="all">All Operators</option>
                                          {operatorNames.map(name => <option key={name} value={name}>{name}</option>)}
                                      </select>
                                      <div className="flex items-center gap-2">
                                          <button onClick={() => setDateFilter('today')} className={`px-3 py-1 rounded-md text-sm ${dateFilter === 'today' ? 'bg-primary-600' : 'bg-gray-600'}`}>Today</button>
                                          <button onClick={() => setDateFilter('7days')} className={`px-3 py-1 rounded-md text-sm ${dateFilter === '7days' ? 'bg-primary-600' : 'bg-gray-600'}`}>Last 7 Days</button>
                                          <button onClick={() => setDateFilter('all')} className={`px-3 py-1 rounded-md text-sm ${dateFilter === 'all' ? 'bg-primary-600' : 'bg-gray-600'}`}>All Time</button>
                                      </div>
                                 </div>
                                  <button onClick={exportLogsToExcel} className="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg">
                                      <DownloadIcon /> Export Excel
                                  </button>
                              </div>
                              <div className="overflow-x-auto bg-gray-800 rounded-lg max-h-[60vh]">
                                 <table className="min-w-full divide-y divide-gray-700">
                                      <thead className="bg-gray-700/50 sticky top-0">
                                          <tr>
                                              {['Timestamp', 'Operator', 'Action', 'Part', 'Qty Change', 'Remaining'].map(h => (
                                                  <th key={h} className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">{h}</th>
                                              ))}
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-700">
                                          {filteredLogs.map((log, index) => (
                                              <tr key={index} className="hover:bg-gray-700/50">
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{new Date(log.timestamp).toLocaleString()}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-white">{log.operatorId}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{log.action}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{log.partName} ({log.partId})</td>
                                                  <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold ${log.quantityChange < 0 ? 'text-red-400' : 'text-green-400'}`}>{log.quantityChange}</td>
                                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-white">{log.remaining}</td>
                                              </tr>
                                          ))}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      );
                   case 'qrcodes':
                      const users = [{ id: SUPERVISOR_QR_ID, name: 'Supervisor (Admin)' }, {id: LOGOUT_QR_ID, name: 'Logout'}, ...Object.entries(TEAM_QR).map(([id, name]) => ({ id, name }))];
                      return <QrCodeManagement parts={parts} users={users} />;
                  default: return null;
              }
          };
          
          return (
              <div id="supervisor-dashboard" className="min-h-screen flex flex-col bg-gray-900 text-white">
                  <header className="bg-gray-800 shadow-md p-4 flex justify-between items-center border-b border-gray-700 z-10">
                      <div className="flex items-center gap-4">
                          <MolexLogo className="w-24"/>
                          <h1 className="text-xl font-bold text-primary-400 hidden sm:block">Supervisor Dashboard</h1>
                      </div>
                      <div>
                        <span className="text-sm text-gray-300 mr-4">Welcome, {currentUser.name}</span>
                        <button onClick={onLogout} className="inline-flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">
                            <LogoutIcon /> Logout
                        </button>
                      </div>
                  </header>
                  <div className="flex-grow flex">
                      <nav className="w-64 bg-gray-900/50 p-4 border-r border-gray-800 flex flex-col">
                          <div className="font-bold text-gray-500 uppercase tracking-wider text-xs mb-4">Menu</div>
                          <ul className="space-y-2">
                              {Object.entries(TABS).map(([key, { label, icon }]) => (
                                  <li key={key}>
                                      <button
                                          onClick={() => setActiveTab(key)}
                                          className={`w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors ${activeTab === key ? 'bg-primary-600 text-white' : 'hover:bg-gray-700 text-gray-300'}`}
                                      >
                                          {icon} {label}
                                      </button>
                                  </li>
                              ))}
                          </ul>
                      </nav>
                      <main className="flex-grow p-6 bg-gray-800/50 overflow-y-auto">
                          {renderContent()}
                      </main>
                  </div>
                  
                  <PartFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleAddPart} />

                  <Modal isOpen={!!qrCodeValue} onClose={() => setQrCodeValue(null)} title="Part QR Code">
                      {qrCodeValue && (
                          <div className="p-4 flex flex-col items-center justify-center">
                              <QRCodeSVG value={qrCodeValue} size={256} className="bg-white p-4 rounded-lg"/>
                              <p className="mt-4 font-mono text-lg text-white">{qrCodeValue}</p>
                          </div>
                      )}
                  </Modal>
              </div>
          );
      };

      // --- From App.tsx ---
      const App = () => {
        const [currentUser, setCurrentUser] = useState(null);
        const [lastError, setLastError] = useState(null);

        const handleLogin = (scannedId) => {
          setLastError(null);
          if (scannedId === SUPERVISOR_QR_ID) {
            setCurrentUser({ id: SUPERVISOR_QR_ID, name: SUPERVISOR_NAME, isSupervisor: true });
            return;
          }
          if (scannedId in TEAM_QR) {
            setCurrentUser({ id: scannedId, name: TEAM_QR[scannedId], isSupervisor: false });
            return;
          }
          setLastError(`Unknown QR Code: ${scannedId}`);
          setTimeout(() => setLastError(null), 3000);
        };

        const handleLogout = () => setCurrentUser(null);
        
        useUsbScanner((scannedCode) => {
            if (!currentUser) handleLogin(scannedCode);
          }, !currentUser);

        const renderContent = () => {
          if (!currentUser) {
            // Note: onSimulateScan is removed from LoginPromptScreen as per previous request
            return <LoginPromptScreen error={lastError} />;
          }
          if (currentUser.isSupervisor) {
            return <SupervisorDashboard currentUser={currentUser} onLogout={handleLogout} />;
          }
          return <OperatorView currentUser={currentUser} onLogout={handleLogout} onSwitchToSupervisor={() => handleLogin(SUPERVISOR_QR_ID)} />;
        };

        return (
          <InventoryProvider>
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans">
              {renderContent()}
            </div>
          </InventoryProvider>
        );
      }

      // --- From index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
